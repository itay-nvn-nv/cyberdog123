name: Build and Push Docker Images

on:
  push:
    branches:
      - main

jobs:
  find-dockerfiles:
    runs-on: ubuntu-latest
    outputs:
      dockerfile_list: ${{ steps.dockerfiles.outputs.dockerfile_list }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find Dockerfiles
        id: dockerfiles
        run: |
          # Determine the parent commit.  Handles initial commit and branch creation cases.
          PARENT_COMMIT=$(git rev-parse --short HEAD^)

          # Check if there's a parent commit
          if [ -z "$PARENT_COMMIT" ]; then
            echo "No parent commit found.  This is likely the first commit."
            CHANGED_FILES=$(git ls-tree -r HEAD --name-only) # Get all files in the repo
          else
            CHANGED_FILES=$(git diff --name-only "$PARENT_COMMIT" HEAD)
          fi

          DOCKERFILES=$(echo "$CHANGED_FILES" | grep "Dockerfile" | tr '\n' ',' | sed 's/,$//')

          if [ -z "$DOCKERFILES" ]; then
            echo "No Dockerfiles found in the changed files. Skipping build and push."
            echo "::set-output name=dockerfile_list::"
          else
            echo "Found Dockerfiles: $DOCKERFILES"
            echo "::set-output name=dockerfile_list::$DOCKERFILES"
          fi

        shell: bash

  build-and-push:
    needs: find-dockerfiles
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    if: needs.find-dockerfiles.outputs.dockerfile_list != ''
    strategy:
      matrix:
        dockerfile: ${{ fromJson(format('[{0}]', needs.find-dockerfiles.outputs.dockerfile_list)) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker Image
        run: |
          directory=$(dirname "${{ matrix.dockerfile }}")
          image_name=$(basename "$directory")
          image_full_name="${{ secrets.DOCKERHUB_USERNAME }}/$image_name:${GITHUB_SHA::7}"

          echo "Building and pushing image: $image_full_name"

          docker build --push \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            --tag "$image_full_name" \
            --file "${{ matrix.dockerfile }}" \
            "$directory"